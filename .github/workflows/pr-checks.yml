name: Pull Request æª¢æŸ¥

on:
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]

# ç¢ºä¿åªæœ‰ä¸€å€‹ç›¸åŒ PR çš„ workflow åœ¨åŸ·è¡Œ
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          # ç²å–å®Œæ•´æ­·å²ä»¥ä¾¿æ›´å¥½çš„ diff åˆ†æ
          fetch-depth: 0

      - name: ğŸ” æª¢æŸ¥æª”æ¡ˆè®Šæ›´
        run: |
          echo "=== æœ¬æ¬¡ PR è®Šæ›´çš„æª”æ¡ˆ ==="
          git diff --name-only origin/${{ github.base_ref }}...HEAD
          echo "=========================="

  # å‰ç«¯æ¸¬è©¦å’Œå»ºç½®
  frontend-tests:
    name: å‰ç«¯æ¸¬è©¦èˆ‡å»ºç½®
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ å®‰è£å‰ç«¯ä¾è³´
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” ESLint ç¨‹å¼ç¢¼æª¢æŸ¥
        working-directory: ./frontend
        run: |
          echo "ğŸ“‹ åŸ·è¡Œ ESLint æª¢æŸ¥..."
          npx eslint src/ --ext .js,.jsx,.ts,.tsx --format=stylish
        continue-on-error: true

      - name: ğŸ¨ Prettier æ ¼å¼æª¢æŸ¥
        working-directory: ./frontend
        run: |
          echo "ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼..."
          npx prettier --check src/
        continue-on-error: true

      - name: ğŸ§ª åŸ·è¡Œå‰ç«¯æ¸¬è©¦
        working-directory: ./frontend
        run: |
          echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦å¥—ä»¶..."
          npm test -- --coverage --watchAll=false
        env:
          CI: true

      - name: ğŸ—ï¸ å»ºç½®å‰ç«¯
        working-directory: ./frontend
        run: |
          echo "ğŸ—ï¸ å»ºç½®å‰ç«¯æ‡‰ç”¨ç¨‹å¼..."
          npm run build

      - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/

  # å¾Œç«¯æ¸¬è©¦å’Œæª¢æŸ¥
  backend-tests:
    name: å¾Œç«¯æ¸¬è©¦èˆ‡æª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ è¨­å®š Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ’¾ å¿«å– UV å’Œä¾è³´
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            backend/.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('backend/uv.lock') }}

      - name: ğŸ“¦ å®‰è£ UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ å®‰è£å¾Œç«¯ä¾è³´
        working-directory: ./backend
        run: |
          echo "ğŸ“¦ å®‰è£ Python ä¾è³´..."
          uv venv
          source .venv/bin/activate
          uv pip install -e .

      - name: ğŸ” ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
        working-directory: ./backend
        run: |
          echo "ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥..."
          source .venv/bin/activate
          # å®‰è£ linting å·¥å…·
          uv pip install black isort flake8
          
          echo "ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼ (Black)..."
          black --check --diff .
          
          echo "ğŸ“¦ æª¢æŸ¥ import é †åº (isort)..."
          isort --check-only --diff .
          
          echo "ğŸ” æª¢æŸ¥ç¨‹å¼ç¢¼å“è³ª (flake8)..."
          flake8 . --max-line-length=88 --extend-ignore=E203,W503
        continue-on-error: true

  # Docker å»ºç½®æ¸¬è©¦
  docker-build:
    name: Docker å»ºç½®æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ³ è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”§ å»ºç½®å‰ç«¯ Docker æ˜ åƒ
        run: |
          echo "ğŸ”§ å»ºç½®å‰ç«¯ Docker æ˜ åƒ..."
          docker build -t lightdance-frontend:test ./frontend
        continue-on-error: true

      - name: ğŸ”§ å»ºç½®å¾Œç«¯ Docker æ˜ åƒ
        run: |
          echo "ğŸ”§ å»ºç½®å¾Œç«¯ Docker æ˜ åƒ..."
          docker build -t lightdance-backend:test ./backend
        continue-on-error: true

      - name: ğŸ³ æ¸¬è©¦ Docker Compose é…ç½®
        run: |
          echo "ğŸ³ æ¸¬è©¦ Docker Compose é…ç½®..."
          # æª¢æŸ¥ docker-compose.dev.yml èªæ³•
          docker compose -f docker-compose.dev.yml config
        continue-on-error: true

  # æ•´åˆæ¸¬è©¦ï¼ˆå¯é¸ï¼‰
  integration-tests:
    name: æ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: success()
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password123
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ”„ ç­‰å¾… MongoDB æº–å‚™å°±ç·’
        run: |
          echo "ğŸ”„ ç­‰å¾… MongoDB æœå‹™å•Ÿå‹•..."
          timeout 30 bash -c 'until nc -z localhost 27017; do sleep 1; done'
          echo "âœ… MongoDB å·²å°±ç·’"

      - name: ğŸ§ª åŸ·è¡ŒåŸºæœ¬ API å¥åº·æª¢æŸ¥
        run: |
          echo "ğŸ§ª æœªä¾†å¯åœ¨æ­¤è™•åŠ å…¥ API æ•´åˆæ¸¬è©¦"
          echo "ğŸ’¡ å»ºè­°ï¼šä½¿ç”¨ pytest æˆ– postman/newman é€²è¡Œ API æ¸¬è©¦"

  # çµæœç¸½çµ
  pr-summary:
    name: PR æª¢æŸ¥ç¸½çµ
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-tests, backend-tests, docker-build, integration-tests]
    if: always()
    
    steps:
      - name: ğŸ“Š æª¢æŸ¥çµæœç¸½çµ
        run: |
          echo "=== Pull Request æª¢æŸ¥çµæœç¸½çµ ==="
          echo "ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.code-quality.result }}"
          echo "å‰ç«¯æ¸¬è©¦: ${{ needs.frontend-tests.result }}"
          echo "å¾Œç«¯æ¸¬è©¦: ${{ needs.backend-tests.result }}"
          echo "Docker å»ºç½®: ${{ needs.docker-build.result }}"
          echo "æ•´åˆæ¸¬è©¦: ${{ needs.integration-tests.result }}"
          echo "============================"
          
          # å¦‚æœæœ‰ä»»ä½•é—œéµæ¸¬è©¦å¤±æ•—ï¼Œå‰‡æ•´é«”å¤±æ•—
          if [[ "${{ needs.frontend-tests.result }}" == "failure" || "${{ needs.backend-tests.result }}" == "failure" ]]; then
            echo "âŒ é—œéµæ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®å¾©"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æª¢æŸ¥é€šéæˆ–åƒ…æœ‰éé—œéµè­¦å‘Š"
          fi